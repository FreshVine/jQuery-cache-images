(function(e){e.fn.cacheImages=function(t){this.cacheImagesConfig=e.extend({},e.fn.cacheImages.defaults,t);this.cacheImagesConfig.encodeOnCanvas=typeof HTMLCanvasElement!=undefined?this.cacheImagesConfig.encodeOnCanvas:false;var n=this;if(/^data:image/.test(this.cacheImagesConfig.defaultImage)===false){this.cacheImagesConfig.defaultSrc=this.cacheImagesConfig.defaultImage}return this.each(function(t,r){e.fn.cacheImages.storageAvailable(e(r),t,r,function(t,r){var i=e(r),s=i.prop("src")||i.data("cachedImageSrc");if(n.cacheImagesConfig.url!==null){s=n.cacheImagesConfig.url;i.prop("src","")}if(typeof s==="undefined"){return true}if(typeof i.prop("src")!=="undefined"&&i.prop("src").substring(0,5)==="data:"){return true}var o=n.cacheImagesConfig.storagePrefix+":"+s;e.fn.cacheImages.get(i,o,function(t,o){if(o&&/^data:image/.test(o)){this.data("cachedImageSrc",s);this.prop("src",o);n.cacheImagesConfig.done.call(this,o);n.cacheImagesConfig.always.call(this);return}else if(o==="pending"){n.cacheImagesConfig.fail.call(this);n.cacheImagesConfig.always.call(this);return}else{this.prop("src","");var u=s.match(/\.(jpg|jpeg|png|gif)$/i);if(u&&u.length){u=u[1].toLowerCase()=="jpg"?"jpeg":u[1].toLowerCase()}if(typeof u==="undefined"){n.cacheImagesConfig.fail.call(this);n.cacheImagesConfig.always.call(this);return}this.data("cachedImageSrc",s);e.fn.cacheImages.set(this,t,"pending",function(e,t){});if(n.cacheImagesConfig.encodeOnCanvas&&u!=="gif"){i.load(function(){newSrc=e.fn.cacheImages.base64EncodeCanvas(r);e.fn.cacheImages.set(this,t,newSrc);if(s.substring(0,5)==="data:"){this.prop("src",newSrc);if(this.is(".cacheImagesRemove")){this.remove()}}})}else{var a=new XMLHttpRequest,f=this;a.open("GET",s,true);a.responseType="arraybuffer";a.onload=function(r){newSrc="";if(this.status==200){newSrc="data:image/"+u+";base64,"+e.fn.cacheImages.base64EncodeResponse(this.response)}e.fn.cacheImages.set(f,t,newSrc,function(t,r){if(r.length!==0&&r!=="data:image/"+u+";base64,"){this.prop("src",r);if(this.is(".cacheImagesRemove")){this.remove()}n.cacheImagesConfig.done.call(this,false);n.cacheImagesConfig.always.call(this);return}else{e.fn.cacheImages.set(this,t,"error",function(e,t){if(typeof n.cacheImagesConfig.defaultSrc!=="undefined"){n.cacheImagesConfig.url=n.cacheImagesConfig.defaultImage;this.cacheImages(n.cacheImagesConfig);return}else{this.prop("src",n.cacheImagesConfig.defaultImage);n.cacheImagesConfig.fail.call(this);n.cacheImagesConfig.always.call(this)}})}})};a.send()}}})})});return this};e.fn.cacheImages.defaults={always:function(){},debug:false,defaultImage:"data:image/png;base64,/9j/4AAQSkZJRgABAgAAZABkAAD/7AARRHVja3kAAQAEAAAAHgAA/+4ADkFkb2JlAGTAAAAAAf/bAIQAEAsLCwwLEAwMEBcPDQ8XGxQQEBQbHxcXFxcXHx4XGhoaGhceHiMlJyUjHi8vMzMvL0BAQEBAQEBAQEBAQEBAQAERDw8RExEVEhIVFBEUERQaFBYWFBomGhocGhomMCMeHh4eIzArLicnJy4rNTUwMDU1QEA/QEBAQEBAQEBAQEBA/8AAEQgAZABkAwEiAAIRAQMRAf/EAEsAAQEAAAAAAAAAAAAAAAAAAAAFAQEAAAAAAAAAAAAAAAAAAAAAEAEAAAAAAAAAAAAAAAAAAAAAEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//2Q==",done:function(e){},encodeOnCanvas:false,fail:function(){},ready:true,storagePrefix:"cached",url:null};e.fn.cacheImages.storageAvailable=function(t,n,r,i){if(typeof localStorage==="object"){i.call(t,n,r);return}if(e.fn.cacheImages.defaults.debug){console.log("localStorage not available")}return};e.fn.cacheImages.set=function(e,t,n,r){localStorage[t]=n;if(typeof r==="function"){r.call(e,t,n)}};e.fn.cacheImages.get=function(e,t,n){var r=null;if(typeof localStorage[t]!=="undefined"){r=localStorage[t]}if(typeof n==="function"){n.call(e,t,r)}};e.fn.cacheImages.base64EncodeCanvas=function(e){try{var t=document.createElement("canvas");t.width=e.width;t.height=e.height;var n=t.getContext("2d");n.drawImage(e,0,0);var r=e.src.match(/\.(jpg|jpeg|png)$/i);if(r&&r.length){r=r[1].toLowerCase()=="jpg"?"jpeg":r[1].toLowerCase()}else{throw"Invalid image type for canvas encoder: "+e.src}return t.toDataURL("image/"+r)}catch(i){console&&console.log(i);return"error"}};e.fn.cacheImages.base64EncodeResponse=function(e){var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r=new Uint8Array(e),i=r.byteLength,s=i%3,o=i-s,u,a,f,l,c;for(var h=0;h<o;h=h+3){c=r[h]<<16|r[h+1]<<8|r[h+2];u=(c&16515072)>>18;a=(c&258048)>>12;f=(c&4032)>>6;l=c&63;t+=n[u]+n[a]+n[f]+n[l]}if(s===1){c=r[o];u=(c&252)>>2;a=(c&3)<<4;t+=n[u]+n[a]+"=="}else if(s===2){c=r[o]<<8|r[o+1];u=(c&16128)>>8;a=(c&1008)>>4;f=(c&15)<<2;t+=n[u]+n[a]+n[f]+"="}return t};e.fn.cacheImages.fetchURL=function(t){e("body").append(e('<img style="display: none;" />').addClass("cacheImagesRemove").cacheImages({url:t}))};e.fn.cacheImages.Output=function(t,n,r){if(typeof r==="undefined"){r=e.fn.cacheImages.defaults.storagePrefix}var i=r+":"+t;if(window.localStorage.getItem(i)!=null){return window.localStorage.getItem(i)}else{if(/^data:image/.test(this.cacheImagesConfig.defaultImage)===true){return this.cacheImagesConfig.defaultImage}i=r+":"+this.cacheImagesConfig.defaultImage;if(window.localStorage.getItem(i)!=null){return window.localStorage.getItem(i)}}return null};e.fn.cacheImages.drop=function(t,n){var r=[],s=false;if(typeof n==="undefined"){n=e.fn.cacheImages.defaults.storagePrefix}if(typeof t==="undefined"){t=null}for(i=0;i<window.localStorage.length;i++){if(window.localStorage.key(i).substr(0,n.length+1)!==n+":"){continue}if(t!==null&&window.localStorage.key(i)!==n+":"+t){continue}r.push(window.localStorage.key(i))}if(r.length===0){if(e.fn.cacheImages.defaults.debug){console.log("No Images to Drop")}return}for(i=0;i<r.length;i++){if(e.fn.cacheImages.defaults.debug){console.log("Dropping localStorage Key:",r[i])}window.localStorage.removeItem(r[i])}if(e.fn.cacheImages.defaults.debug){console.log("Dropped "+r.length+" images from storage")}return}})(jQuery)